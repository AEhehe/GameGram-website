<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GameGram Chat</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap');
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 1.5rem;
      background: #121212;
      color: #e0e0e0;
      font-family: 'Fira Mono', monospace;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    h2 { margin-bottom: 1rem; font-weight: 700; text-align: center; letter-spacing: 0.05em; color: #ff6f61; }
    #peerId { font-weight: 700; color: #61dafb; user-select: all; }
    .container { max-width: 700px; margin: 0 auto; display: flex; flex-direction: column; gap: 1.5rem; }
    form { display: flex; gap: 0.7rem; }
    input[type="text"] {
      flex: 1; padding: 0.5rem 0.75rem; font-size: 1rem;
      border: 2px solid #333; border-radius: 6px; background: #1f1f1f; color: #e0e0e0;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus { outline: none; border-color: #61dafb; background: #222; }
    button {
      background: #ff6f61; border: none; color: white; padding: 0 1rem;
      font-family: 'Fira Mono', monospace; font-size: 1rem; font-weight: 700;
      border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease;
    }
    button:hover { background: #e2584b; }
    button:active { background: #b5423a; }
    #connectionsSection {
      background: #1b1b1b; border-radius: 8px; padding: 1rem; box-shadow: 0 0 10px #ff6f61aa;
    }
    #connectionsSection > h3 { margin-top: 0; font-weight: 600; color: #ff6f61; }
    #connCount { font-weight: 700; color: #61dafb; }
    #connectionsList {
      margin-top: 0.75rem; max-height: 120px; overflow-y: auto;
      list-style: none; padding-left: 1rem;
    }
    #connectionsList li {
      padding: 0.3rem 0; border-bottom: 1px solid #333; color: #ccc; user-select: text;
    }
    #chat {
      background: #1a1a1a; color: #a3ffa3;
      border-radius: 8px; padding: 1rem; height: 260px; overflow-y: auto;
      box-shadow: inset 0 0 10px #2f2;
    }
    #chat p {
      margin: 0 0 0.4rem 0; line-height: 1.3;
    }
    #chat p:nth-child(odd) {
      color: #7ff17f;
    }
    label {
      font-weight: 600; color: #ff6f61; white-space: nowrap; align-self: center;
    }
    @media (max-width: 480px) {
      body { padding: 1rem; }
      #chat { height: 180px; }
      form { flex-direction: column; }
      button { width: 100%; }
    }
  </style>
</head>
<body>

<h2>GameGram Chat</h2>
<div class="container">

  <div>Your ID: <span id="peerId" title="Click to copy">...</span></div>

  <form id="connectForm" autocomplete="off" spellcheck="false">
    <label for="connectToId">Connect to peer ID:</label>
    <input type="text" id="connectToId" placeholder="Enter peer ID" required />
    <button type="submit">Connect</button>
  </form>

  <form id="nickForm" autocomplete="off" spellcheck="false">
    <label for="nicknameInput">Your nickname:</label>
    <input type="text" id="nicknameInput" placeholder="Enter your nickname" maxlength="20" />
    <button type="submit">Change Nickname</button>
  </form>

  <section id="connectionsSection">
    <h3>Connected Peers (<span id="connCount">0</span>)</h3>
    <ul id="connectionsList"></ul>
  </section>

  <div id="chat"></div>

  <form id="messageForm" autocomplete="off" spellcheck="false">
    <input type="text" id="messageInput" placeholder="Type message here" autocomplete="off" />
    <button type="submit">Send</button>
  </form>

</div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
  const peerIdSpan = document.getElementById('peerId');
  const connectForm = document.getElementById('connectForm');
  const connectToIdInput = document.getElementById('connectToId');
  const connectionsList = document.getElementById('connectionsList');
  const connCountSpan = document.getElementById('connCount');
  const chatDiv = document.getElementById('chat');
  const messageForm = document.getElementById('messageForm');
  const messageInput = document.getElementById('messageInput');
  const nickForm = document.getElementById('nickForm');
  const nicknameInput = document.getElementById('nicknameInput');

  let peer;
  const connections = new Map();
  const nicknames = new Map();
  let localPeerId = null;
  let localNickname = localStorage.getItem('nickname') || `User_${Math.floor(Math.random() * 1000)}`;
  let isAdmin = false;
  let adminPeerIds = new Set();

  const MSG_TYPES = {
    CHAT: 'chat',
    NICKNAME: 'nickname',
    KICK: 'kick',
    ADMIN_ANNOUNCE: 'admin_announce'
  };

  function addChatMessage(msg, from = 'System', isSystem = false) {
    const p = document.createElement('p');
    p.textContent = `[${from}] ${msg}`;
    if (isSystem) p.style.fontStyle = 'italic';
    chatDiv.appendChild(p);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  function updateConnectionsUI() {
    connectionsList.innerHTML = '';
    for (const [peerId, conn] of connections.entries()) {
      const li = document.createElement('li');
      const nick = nicknames.get(peerId) || peerId;
      li.textContent = nick + (peerId === localPeerId ? " (You)" : "");
      if (peerId === localPeerId && isAdmin) li.textContent += " [Admin]";
      connectionsList.appendChild(li);
    }
    connCountSpan.textContent = connections.size;
  }

  function broadcastMessage(obj) {
    connections.forEach(conn => {
      if (conn.open) conn.send(obj);
    });
  }

  function handleConnection(conn) {
    if (connections.has(conn.peer)) return;
    connections.set(conn.peer, conn);
    nicknames.set(conn.peer, conn.peer);

    updateConnectionsUI();
    addChatMessage(`Connected to ${conn.peer}`, 'System', true);

    conn.on('open', () => {
      conn.send({ type: MSG_TYPES.NICKNAME, nickname: localNickname });
      if (isAdmin) conn.send({ type: MSG_TYPES.ADMIN_ANNOUNCE });
    });

    conn.on('data', data => {
      if (typeof data === 'object' && data.type) {
        switch (data.type) {
          case MSG_TYPES.CHAT:
            addChatMessage(data.message, nicknames.get(conn.peer) || conn.peer);
            break;
          case MSG_TYPES.NICKNAME:
            nicknames.set(conn.peer, data.nickname || conn.peer);
            updateConnectionsUI();
            break;
          case MSG_TYPES.ADMIN_ANNOUNCE:
            if (conn.peer !== localPeerId) {
              isAdmin = false;
              updateConnectionsUI();
            }
            break;
          case MSG_TYPES.KICK:
            if (data.target === localPeerId) {
              addChatMessage('You were kicked by admin.', 'System', true);
              alert('You were kicked by the admin.');
              disconnectAll();
            }
            break;
        }
      } else {
        addChatMessage(data, nicknames.get(conn.peer) || conn.peer);
      }
    });

    conn.on('close', () => {
      connections.delete(conn.peer);
      nicknames.delete(conn.peer);
      updateConnectionsUI();
      addChatMessage(`Disconnected from ${conn.peer}`, 'System', true);
      if (connections.size === 0) {
        isAdmin = true;
        updateConnectionsUI();
        addChatMessage('You are now the admin.', 'System', true);
      }
    });
  }

  function disconnectAll() {
    connections.forEach(conn => conn.close());
    connections.clear();
    nicknames.clear();
    updateConnectionsUI();
  }

  fetch('peers.json')
    .then(res => res.json())
    .then(data => {
      if (Array.isArray(data)) {
        adminPeerIds = new Set(data);
        if (localPeerId && adminPeerIds.has(localPeerId)) {
          isAdmin = true;
          updateConnectionsUI();
          addChatMessage('You are admin (peer ID matched).', 'System', true);
        }
      }
    });

  function createPeer(id) {
    peer = new Peer(id);

    peer.on('open', id => {
      localPeerId = id;
      peerIdSpan.textContent = id;
      localStorage.setItem('peerId', id);
      if (adminPeerIds.has(id)) {
        isAdmin = true;
        addChatMessage('You are admin (peer ID matched).', 'System', true);
      }
      updateConnectionsUI();
    });

    peer.on('connection', handleConnection);

    peer.on('error', err => {
      addChatMessage('Peer error: ' + err, 'Error');
      if (['unavailable-id', 'peer-unavailable'].includes(err.type)) {
        localStorage.removeItem('peerId');
        createPeer(null);
      }
    });
  }

  createPeer(localStorage.getItem('peerId'));

  connectForm.addEventListener('submit', e => {
    e.preventDefault();
    const targetId = connectToIdInput.value.trim();
    if (!targetId || connections.has(targetId)) return;
    const conn = peer.connect(targetId);
    conn.on('open', () => {
      handleConnection(conn);
      conn.send({ type: MSG_TYPES.NICKNAME, nickname: localNickname });
      if (isAdmin) conn.send({ type: MSG_TYPES.ADMIN_ANNOUNCE });
    });
    connectToIdInput.value = '';
  });

  nickForm.addEventListener('submit', e => {
    e.preventDefault();
    const newNick = nicknameInput.value.trim();
    if (!newNick) return;
    localNickname = newNick;
    localStorage.setItem('nickname', newNick);
    broadcastMessage({ type: MSG_TYPES.NICKNAME, nickname: newNick });
    addChatMessage(`Nickname changed to "${newNick}"`, 'System', true);
    updateConnectionsUI();
    nicknameInput.value = '';
  });

  messageForm.addEventListener('submit', e => {
    e.preventDefault();
    const msg = messageInput.value.trim();
    if (!msg) return;

    if (isAdmin && msg.startsWith('/kick ')) {
      const targetNick = msg.slice(6).trim();
      let targetPeerId = null;
      for (const [id, nick] of nicknames.entries()) {
        if (nick === targetNick) targetPeerId = id;
      }
      if (targetPeerId) {
        const conn = connections.get(targetPeerId);
        if (conn && conn.open) {
          conn.send({ type: MSG_TYPES.KICK, target: targetPeerId });
          conn.close();
          connections.delete(targetPeerId);
          nicknames.delete(targetPeerId);
          updateConnectionsUI();
        }
      }
      messageInput.value = '';
      return;
    }

    broadcastMessage({ type: MSG_TYPES.CHAT, message: msg });
    addChatMessage(msg, localNickname);
    messageInput.value = '';
  });

  peerIdSpan.addEventListener('click', () => {
    navigator.clipboard.writeText(localPeerId).then(() => {
      addChatMessage('Peer ID copied to clipboard.', 'System', true);
    });
  });
</script>
</body>
</html>
